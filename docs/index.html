<html>
<head>
	<title>FortiGate AWS same-zone HA</title>
	<link rel="icon" href="favicon.ico" type="image/x-icon"/>

	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js" integrity="sha256-eGE6blurk5sHj+rmkfsGYeKyZx3M4bG+ZlFyA7Kns7E=" crossorigin="anonymous"></script>

	<script src="networks.js"></script>
	<script src="cloning.js"></script>
	<script src="switch_device.js"></script>
	<script src="depends.js"></script>

	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css"/>
	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="document.css"/>

	<script>
		function generate_vpc_config() {
			let ip   = IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=vpcNetwork]').val());
			let mask = IPv4_cidr_to_number($('#config-intrazone-vpc input[type=text][name=vpcMask]').val());
			let external = IPv4_number_to_string((ip&mask)+IPv4_string_to_number("0.0.1.0"));
			let internal = IPv4_number_to_string((ip&mask)+IPv4_string_to_number("0.0.2.0"));
			let ha       = IPv4_number_to_string((ip&mask)+IPv4_string_to_number("0.0.3.0"));
			let mgmt     = IPv4_number_to_string((ip&mask)+IPv4_string_to_number("0.0.4.0"));

			$('#config-intrazone-vpc input[type=text][name=externalNetwork]').val(external);
			$('#config-intrazone-vpc input[type=text][name=internalNetwork]').val(internal);
			$('#config-intrazone-vpc input[type=text][name=haNetwork]').val(ha);
			$('#config-intrazone-vpc input[type=text][name=mgmtNetwork]').val(mgmt);
			$('#config-intrazone-vpc input[type=text][name=externalMask]').val("24");
			$('#config-intrazone-vpc input[type=text][name=internalMask]').val("24");
			$('#config-intrazone-vpc input[type=text][name=haMask]').val("24");
			$('#config-intrazone-vpc input[type=text][name=mgmtMask]').val("24");
		}

		function generate_nics_config() {
			// first device
			let port1primary   = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=externalNetwork]').val())+4);
			let port1secondary = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=externalNetwork]').val())+6);
			let port2primary   = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=internalNetwork]').val())+4);
			let port2secondary = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=internalNetwork]').val())+6);
			let port3primary   = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=haNetwork]').val())+4);
			let port4primary   = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=mgmtNetwork]').val())+4);

			$('#config-intrazone-nics-first input[type=text][name=port1PrimaryIp]').val(port1primary);
			$('#config-intrazone-nics-first input[type=text][name=port1SecondaryIp]').val(port1secondary);
			$('#config-intrazone-nics-first input[type=text][name=port2PrimaryIp]').val(port2primary);
			$('#config-intrazone-nics-first input[type=text][name=port2SecondaryIp]').val(port2secondary);
			$('#config-intrazone-nics-first input[type=text][name=port3PrimaryIp]').val(port3primary);
			$('#config-intrazone-nics-first input[type=text][name=port4PrimaryIp]').val(port4primary);

			$('#config-intrazone-ec2-first input[type=text][name=port1PrimaryIp]').val(port1primary);
			$('#config-intrazone-ec2-first input[type=text][name=port1SecondaryIp]').val(port1secondary);

			// second device
			port1primary   = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=externalNetwork]').val())+5);
			port1secondary = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=externalNetwork]').val())+6);
			port2primary   = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=internalNetwork]').val())+5);
			port2secondary = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=internalNetwork]').val())+6);
			port3primary   = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=haNetwork]').val())+5);
			port4primary   = IPv4_number_to_string(IPv4_string_to_number($('#config-intrazone-vpc input[type=text][name=mgmtNetwork]').val())+5);

			$('#config-intrazone-nics-second input[type=text][name=port1PrimaryIp]').val(port1primary);
			$('#config-intrazone-nics-second input[type=text][name=port1SecondaryIp]').val(port1secondary);
			$('#config-intrazone-nics-second input[type=text][name=port2PrimaryIp]').val(port2primary);
			$('#config-intrazone-nics-second input[type=text][name=port2SecondaryIp]').val(port2secondary);
			$('#config-intrazone-nics-second input[type=text][name=port3PrimaryIp]').val(port3primary);
			$('#config-intrazone-nics-second input[type=text][name=port4PrimaryIp]').val(port4primary);

			$('#config-intrazone-ec2-second input[type=text][name=port1PrimaryIp]').val(port1primary);
			$('#config-intrazone-ec2-second input[type=text][name=port1SecondaryIp]').val(port1secondary);
		}

		function generate_intrazone_config() {
			let config = "";

			let [thisDeviceSuffix, otherDeviceSuffix] = switch_device_current_suffix();

			// get values and check for errors
			let hostname      = $('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=text][name=hostname]').val();
			let admintimeout  = $('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=text][name=admintimeout]').val();
			let timezone      = $('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=text][name=timezone]').val();

			let port1Ip = $('#config-intrazone-nics-'+thisDeviceSuffix+' input[type=text][name=port1SecondaryIp]').val();
			let port2Ip = $('#config-intrazone-nics-'+thisDeviceSuffix+' input[type=text][name=port2SecondaryIp]').val();
			let port3Ip = $('#config-intrazone-nics-'+thisDeviceSuffix+' input[type=text][name=port3PrimaryIp]').val();
			let port4Ip = $('#config-intrazone-nics-'+thisDeviceSuffix+' input[type=text][name=port4PrimaryIp]').val();
			let port1Mask = $('#config-intrazone-vpc input[type=text][name=externalMask]').val();
			let port2Mask = $('#config-intrazone-vpc input[type=text][name=internalMask]').val();
			let port3Mask = $('#config-intrazone-vpc input[type=text][name=haMask]').val();
			let port4Mask = $('#config-intrazone-vpc input[type=text][name=mgmtMask]').val();

			let haPriority = $('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=text][name=ha-priority]').val();
			let haPeer     =  $('#config-intrazone-nics-'+otherDeviceSuffix+' input[type=text][name=port3PrimaryIp]').val();

			let errors = "";
			if (port1Ip.length == 0 || port1Ip == "0.0.0.0") errors += "- Port1 secondary IP address missing.\n";
			if (port2Ip.length == 0 || port2Ip == "0.0.0.0") errors += "- Port2 secondary IP address missing.\n";
			if (port3Ip.length == 0 || port3Ip == "0.0.0.0") errors += "- Port3 primary IP address missing.\n";
			if (port4Ip.length == 0 || port4Ip == "0.0.0.0") errors += "- Port4 primary IP address missing.\n";

			if (errors.length > 0) {
				errors = "Cannot generate config file because of following errors:\n\n" + errors;
				alert(errors);
				return false;
			}

			// global settings
			config += 'config system global\n';
			if (hostname.length > 0) {
			config += '    set hostname '        + hostname + "\n";
			}
			if (admintimeout.length > 0) {
			config += '    set admintimeout '    + admintimeout + "\n";
			}
			if (timezone.length > 0) {
			config += '    set timezone '        + timezone + "\n";
			}
			config += 'end\n';
			config += '\n';
			
			// interfaces
			config += 'config system interface\n';
			config += '    edit port1\n';
			config += '        set mode static\n';
			config += '        set ip ' + port1Ip + '/' + port1Mask + "\n";
			config += '        set allowaccess ping ssh\n';
			config += '        set alias external\n';
			config += '    next\n';
			config += '    edit port2\n';
			config += '        set mode static\n';
			config += '        set ip ' + port2Ip + '/' + port2Mask + "\n";
			config += '        set allowaccess ping\n';
			config += '        set alias internal\n';
			config += '    next\n';
			config += '    edit port3\n';
			config += '        set mode static\n';
			config += '        set ip ' + port3Ip + '/' + port3Mask + "\n";
			config += '        set allowaccess ping\n';
			config += '        set alias ha\n';
			config += '    next\n';
			config += '    edit port4\n';
			config += '        set mode static\n';
			config += '        set ip ' + port4Ip + '/' + port4Mask + "\n";
			config += '        set allowaccess ping ssh https\n';
			config += '        set alias management\n';
			config += '    next\n';
			config += 'end\n';
			config += '\n';

			// routing
			if ($('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=checkbox][name=default-route-port1]').is(':checked')) {
				let ip   = IPv4_string_to_number(port1Ip);
				let mask = IPv4_cidr_to_number(port1Mask);
				let dgw  = IPv4_number_to_string((ip&mask)+1);

				config += 'config router static\n';
				config += '    edit 0\n';
				config += '        set device port1\n';
				config += '        set gateway ' + dgw + '\n';
				config += '    next\n';
				config += 'end\n';
				config += '\n';
			}

			// ha
			let haIp   = IPv4_string_to_number(port4Ip);
			let haMask = IPv4_cidr_to_number(port4Mask);
			let haDgw  = IPv4_number_to_string((haIp&haMask)+1);
			config += 'config system ha\n';
			config += '    set group-name "fgtha"\n';
			config += '    set mode a-p\n';
			config += '    set password topsecret\n';
			config += '    set hbdev "port3" 50\n';
			config += '    set ha-mgmt-status enable\n';
			config += '    config ha-mgmt-interfaces\n';
			config += '        edit 0\n';
			config += '            set interface "port4"\n';
			config += '            set gateway ' + haDgw + "\n";
			config += '        next\n';
			config += '    end\n';
			config += '    set override enable\n';
			config += '    set priority ' + haPriority + "\n";
			config += '    set unicast-hb enable\n';
			config += '    set unicast-hb-peerip ' + haPeer + "\n";
			config += 'end\n';
			config += '\n';

			// ipsec configuration
			if ($('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=checkbox][name=ipsec]').is(':checked')) {
				// local user
				config += 'config user local\n';
				config += '    edit "client"\n';
				config += '        set type password\n';
				config += '        set passwd "' + $('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=text][name=ipsec-client-password]').val() + '"\n';
				config += '    next\n';
				config += 'end\n';
				config += '\n';
				// local user group
				config += 'config user group\n';
				config += '    edit "vpnclients"\n';
				config += '        set member "client"\n';
				config += '    next\n';
				config += 'end\n';
				config += '\n';
				// phase 1
				config += 'config vpn ipsec phase1-interface\n';
				config += '    edit "clients"\n';
				config += '        set type dynamic\n';
				config += '        set interface "port1"\n';
				config += '        set mode aggressive\n';
				config += '        set peertype any\n';
				config += '        set mode-cfg enable\n';
				config += '        set localid "fgtaws"\n';
				config += '        set xauthtype auto\n';
				config += '        set authusrgrp "vpnclients"\n';
				config += '        set ipv4-start-ip 169.254.111.2\n';
				config += '        set ipv4-end-ip 169.254.111.254\n';
				config += '        set psksecret "' + $('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=text][name=ipsec-psk]').val() + '"\n';
				config += '    next\n';
				config += 'end\n';
				config += '\n';
				// phase 2
				config += 'config vpn ipsec phase2-interface\n';
				config += '    edit "clients"\n';
				config += '        set phase1name "clients"\n';
				config += '        set keepalive enable\n';
				config += '    next\n';
				config += 'end\n';
				config += '\n';
			}

			// firewall policies
			if ($('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=checkbox][name=policy-default]').is(':checked')) {
				config += 'config firewall policy\n';

				config += '    edit 0\n';
				config += '        set name "default from internal to external"\n';
				config += '        set srcintf "port2"\n';
				config += '        set dstintf "port1"\n';
				config += '        set srcaddr "all"\n';
				config += '        set dstaddr "all"\n';
				config += '        set action accept\n';
				config += '        set schedule "always"\n';
				config += '        set service "ALL"\n';
				config += '        set nat enable\n';
				config += '    next\n';

				if ($('#config-intrazone-fgt-'+thisDeviceSuffix+' input[type=checkbox][name=ipsec]').is(':checked')) {
					config += '    edit 0\n';
					config += '        set name "ipsec from external to internal"\n';
					config += '        set srcintf "clients"\n';
					config += '        set dstintf "port2"\n';
					config += '        set srcaddr "all"\n';
					config += '        set dstaddr "all"\n';
					config += '        set action accept\n';
					config += '        set schedule "always"\n';
					config += '        set service "ALL"\n';
					config += '        set nat enable\n';
					config += '    next\n';
				}

				config += 'end\n';
				config += '\n'
			}

			config = config.trimEnd()+"\n";
			$('#dialog-userdata textarea[name=config]').text(config);
			return true;
		}

		function generate_default_config() {
			$('#config-intrazone-vpc input[type=text][name=vpcNetwork]').val("10.0.0.0");
			$('#config-intrazone-vpc input[type=text][name=vpcMask]').val("16");

			generate_vpc_config();
			generate_nics_config();
			generate_intrazone_config();
		}

		function onload() {
			cloning_setup();
			switch_device_setup();
			depends_setup();

			// add easy open function to all dialogs
			$('[data-type=dialog]').each(function (index, element) {
				$(element).bind('openDialog', function() {
					$(element).dialog({
						resizable: false,
						modal: true,
						height:'auto',
						width:'auto',
						position: {
							my: 'center',
							at: 'center',
							of: '#overlay'
						}
					});
				});
			});
		}
	</script>
</head>
<body onload="onload()">
	<div id="main-content">
	<h1>FortiGate native same-zone A-P HA in AWS</h1>

	<h2>Design</h2>

	<div name="indent1">

		<p>Be aware that FortiGate in AWS will automatically recognize the HA setup within the same availability
	   zone and adjust its HA failover behavior. The principles shown on this page may not work correctly with
		multi-zone HA configuration.</p>

		<h3>Expected layout</h3>
		<ul>
		<li><b>port1</b> : External ("public") interface that is connected to Internet by assigning floating public IP address in AWS. 
		<li><b>port2</b> : Internal interface connected to the private network built in AWS. All traffic to and from this network
		                   needs to pass through FortiGate, which is achived by configuring the routing table bound to this subnet in AWS
		                   with default route via the port2 interface of FortiGate.</li>
		<li><b>port3</b> : Dedicated HA heartbeat interface.</li>
		<li><b>port4</b> : Dedicated management interface. It is not strictly necessary but it allows to connect directly to either device
		                   device in the cluster, even if the AWS failover failed for any reason. It expects two additional public ("elastic")
		                   IP addresses, each attached to different FortiGate in the cluster.</li>
		</ul>
	
		<h3>Basic principles</h3>
		<ul>
		<li>To be able to attach at least 4 network interfaces, the instance ("VM") size in AWS must contain at least 4 CPU.
		    Smalles usable size in this case is "t3.xlarge".</li>
		<li>Network interfaces in AWS matching port1 and port2 interfaces on FortiGate must be configured with primary and secondary
		    address. However, in FortiGate config file the AWS primary address is not used at all and there isn't any secondary IP
			 configuration enabled.
			 Both interfaces are statically configured with "set ip ..." using the secondary address from AWS configuration.</li>
		<li>FortiGate configuration in the cluster is fully synchronized, including the network interfaces and routing sections.
		    This is possible because the IP addresses configured on port1 and port2 are "floating" in AWS configuration.</li>
		<li>It is not simply possible to test port3 and port4 configuration by pinging because each of these two interfaces
		    is automatically placed to dedicated hidden VDOM when HA is enabled.</li>
		<li>Unlike FortiGate deployment in Azure, in AWS there is no SDN connector configuration needed (nor available) to support
		    HA failover.</li>
		<li>After HA failover the new master FortiGate device:
			<ul>
			<li>Moves the secondary IPs configured on port1 and port2 in AWS to the respective interfaces of the new master device.</li>
			<li>Re-assigns the "floating" public IP to the port1 of the new master device.</li>
			<li>Re-assigns the default route in subnet connected to port2 via port2 interface of the new master device.</li>
			</ul>
		</li>
		</ul>
	</div>

	<div name="manual-intrazone-step-vpc">
		<h2>Create VPC configuration</h2>
		<div name="indent1">
			<h3>Create VPC with specified IP range and 4 subnets with IP ranges from the VPC range.</h3>
	
			<ul>
			<li>The VPC IP range does not matter and you can keep the default one unless you plan to interconnect
			    different VPCs in the future.</li>
			<li>Create four new subnets in the VPC using the IP range configuration from the table bellow.
			    Make sure you explicitly select the same "Availability zone" for each newly created subnet.
			    <span class="note">(Otherwise you won't be able to attach the interface to VM later.)</span></li>
			</ul>
	
			<table id="config-intrazone-vpc">
				<tr><td>VPC address range:</td><td><input type="text" name="vpcNetwork" value="10.0.0.0"/> / <input type="text" name="vpcMask" value="16" readonly size="2"/></td><tr>
				<tr><td colspan="2"><input type="button" name="generate" value="Generate subnets configuration" onclick="generate_vpc_config()"/></td></tr>
				<tr><td>External subnet:</td><td><input type="text" name="externalNetwork" value=""/> / <input type="text" name="externalMask" value="24" size="2"/></td><tr>
				<tr><td>Internal subnet:</td><td><input type="text" name="internalNetwork" value=""/> / <input type="text" name="internalMask" value="24" size="2"/></td><tr>
				<tr><td>HA subnet:</td><td><input type="text" name="haNetwork" value=""/> / <input type="text" name="haMask" value="24" size="2"/></td><tr>
				<tr><td>Management subnet:</td><td><input type="text" name="mgmtNetwork" value=""/> / <input type="text" name="mgmtMask" value="24" size="2"/></td><tr>
			</table><br/>
	
			<h3>Create new Internet gateway</h3>
			<ul>
			<li>Attach it to your VPC.</li>
			</ul>
			<p><span class="note">This will allow future public IPs to be reachable correctly.</span></p>
	
			<h3>Create new "external" route table</h3>
			<ul>
			<li>Associate it to "external" subnet.</li>
			<li>In the route table create new route with destination "0.0.0.0/0" and as the target use the previously created Internet gateway.
			    <span class="note">(This is necessary for the shared public IP that will be attached later.)</span></li>
			</ul>
	
			<h3>Create new "management" route table</h3>
			<ul>
			<li>Associate it to "management" subnet.</li>
			<li>In the route table create new route with destination "0.0.0.0/0" and as the target use the previously created Internet gateway.
			    <span class="note">(This is necessary for the dedicated management public IP that will be attached later.)</span></li>
			</ul>
	
			<h3>Create new "internal" route table</h3>
			<ul>
			<li>Associate it to "internal" subnet.</li>
			</ul>
			<p><span class="note">Default route via port2 of master FortiGate device will be added later when the first FortiGate VM is deployed.</span></p>
	
			<h3>Create three new public (elastic) IP addresses</h3>

			<ul>
			<li><b>shared</b> : Floating IP always pointing to actual master's port1 ("external") interface.
			<li><b>mgmt1</b>  : First FortiGate management always pointing to its port4 ("management") interface.
			<li><b>mgmt2</b>  : Second FortiGate management always pointing to its port4 ("management") interface.
			</ul>

			<p><span class="note">At this moment there are no VMs to attach the public IP to, so this fill be finished later.</span></p>

			<h3>Create new security group</h3>
			<ul>
			<li>This will be policy allowing all traffic to and from the FortiGates without any filtering in AWS.
			    <span class="note">(FortiGate is hardened security device so this shouldn't be an issue.)</span></li>
			<li>Make sure the right VPC is selected in new security group dialog.</li>
			<li>In <b>Inbound rules</b> section add a new rule and allow "All traffic" with "Anywhere" as source.</li>
			<li>Validate that in <b>Outbound rules</b> section the same rule already exists.</li>
			</ul>

		</div>

		<h2>Create additional network interfaces</h2>
		<div name="indent1">
			<p><span class="note">In AWS maximum of two network interfaces can be specified when deploying new VM (instance). Because we need four of them,
			                      we will create port2, port3 and port4 AWS interfaces manually and let AWS deployment wizzard to create only port1.
			                      Then immediately when the VM (instance) is created we will quickly attach the other three interfaces.</span></p>

			<ul>
			<li>In EC2 AWS console create three interfaces for first FortiGate device and another three for the second FortiGate device.
			    <span class="note">(It is wise to use tag "Name" with identification of FortiGate device and its port name to find it later easily.)</span></li>
			<li>Attach each interface to the right network <b>subnet</b>. <span class="note">(Use the table bellow.)</span></li>
			<li>Select "Custom" <b>IPv4 Private IP</b> and specify the right primary IP address. <span class="note">(Use the table bellow.)</span></li>
			<li>As the <b>security group</b> select the one you created in previous section.</li>
			<li>When port2 interface for first FortiGate device is created, right click on it, select <b>Manage IP Addresses</b> and add the secondary IP addresses.
			    <span class="note">(Use the table bellow.) (Be aware that this is done only for the first FortiGate device which will start as the master.)</span></li>
			</ul>

			<div data-generate="switch-device"></div>
			<table id="config-intrazone-nics-first" data-clone="config-intrazone-nics-second" data-switch="device-specific">
				<tr><td colspan="2"><input type="button" name="generate" value="Generate IPs from subnets" onclick="generate_nics_config()"/></td></tr>
				<tr class="disabled"><td>Port1 ("external") primary IP:</td><td><input type="text" name="port1PrimaryIp" value=""/></td></tr>
				<tr class="disabled"><td>Port1 ("external") secondary IP:</td><td><input type="text" name="port1SecondaryIp" value=""/></td></tr>
				<tr><td>Port2 ("internal") primary IP:</td><td><input type="text" name="port2PrimaryIp" value=""/></td></tr>
				<tr><td>Port2 ("internal") secondary IP:</td><td><input type="text" name="port2SecondaryIp" value=""/></td></tr>
				<tr><td>Port3 ("ha") primary IP:</td><td><input type="text" name="port3PrimaryIp" value=""/></td></tr>
				<tr><td>Port4 ("management") primary IP:</td><td><input type="text" name="port4PrimaryIp" value=""/></td></tr>
			</table>
		</div>

		<h2>Create new VM (EC2 instance)</h2>
		<div name="indent1">
			<ul>
			<li>In EC2 AWS console launch a new instance and in "AWS Marketplace" section find FortiGate. There are two types of images available:
				<ul>
				<li><b>PAYG</b> : No explicit VM license is needed but the price is higher by the fee paid to Fortinet for using the FortiGate VM.
				                  The auto-configuration used in this guide always works correctly.
				<li><b>BYOL</b> : When VM of this type boots up, not all features are configurable until user uploads the valid FortiGate VM license.
				                  Based on experience, this guide usually works as right as for PAYG images, but if something hasn't auto-configured
				                  correctly, check the configuration on FortiGate and copy &amp; paste missing sections if needed.
				</ul></li>
			<li>At the instance size select "t3.xlarge". <span class="note">(At least four network interfaces are needed which means the instance must
			    have at least four CPUs.)</span>
			<li>On the "Instance details" configuration page select:
				<ul>
					<li><b>Network</b> : The VPC you created in the first section of this guide.</li>
					<li><b>Subnet</b> : The external subnet you created before. AWS will use this as port1 FortiGate interface.</li>
					<li><b>IAM role</b> : "FortiOS_unicast_HA" - this is the role pre-created in the Fortinet EMEA TAC account. If you are deploying this in another account, 
					    <a href="javascript:$('#dialog-iam-role-unicast-ha').trigger('openDialog')">
					    the right IAM role</a> must be created in advance.</li>
					<li><b>Network interfaces</b> : For auto-generated interface "eth0" specify primary and secondary (only for first "master" FortiGate) IP addresses
					       based on the following table:
						<br/><br/>
						<div data-generate="switch-device"></div>
						<table id="config-intrazone-ec2-first" data-clone="config-intrazone-ec2-second" data-switch="device-specific">
							<tr><td colspan="2"><input type="button" name="generate" value="Generate IPs from subnets" onclick="generate_nics_config()"/></td></tr>
							<tr><td>Port1 ("external") primary IP:</td><td><input type="text" name="port1PrimaryIp" value=""/></td></tr>
							<tr><td>Port1 ("external") secondary IP:</td><td><input type="text" name="port1SecondaryIp" value=""/></td></tr>
						</table>
					</li>
					<li><b>User data</b> : Content of this field is the configuration that is automatically merged when the FortiGate boots up for the first time.
					                       Use the following table to generate the right configuration:
						<br/><br/>

						<div data-generate="switch-device"></div>
						<table id="config-intrazone-fgt-first" data-clone="config-intrazone-fgt-second"
						                                       data-set="ha-priority:100;hostname:awsfgt2"
						                                       data-switch="device-specific">
							<tr><td>Hostname:</td><td><input type="text" name="hostname" value="awsfgt1"/></td><tr>
							<tr><td>Admin timeout:</td><td><input type="text" name="admintimeout" value="480"/></td><tr>
							<tr><td>Timezone:</td><td><input type="text" name="timezone" value="27"/></td><tr>
							<tr><td>Create default firewall policy from port2 to port1:</td><td><input type="checkbox" name="policy-default" checked/></td><tr>
							<tr><td>Create default route through port1:</td><td><input type="checkbox" name="default-route-port1" checked/></td><tr>
							<tr><td>Create IPSec VPN responder configuration:</td><td><input type="checkbox" name="ipsec" checked/></td><tr>
							<tr><td>IPSec preshared secret:</td><td><input type="text" name="ipsec-psk" value="FortiAws99!" data-depends="ipsec"/></td><tr>
							<tr><td>IPSec XAUTH "client" password:</td><td><input type="text" name="ipsec-client-password" value="client" data-depends="ipsec"/></td><tr>
					
							<tr><td>HA priority:</td><td><input type="text" name="ha-priority" value="200"/></td><tr>
					
							<tr><td colspan="2"><input type="button" name="generate" value="Generate config script" onclick="generate_intrazone_config() && $('#dialog-userdata').trigger('openDialog')"/></td></tr>
						</table>
					</li>
				</ul></li>
				<li>Finish the deployment wizzard. When asked to select the <b>security group</b>, select again the one you created in previous section.</li>
				<li>Keep monitoring the state of the new instance. As soon as it changes from "Pending" to "Running", navigate to EC2 "Network interfaces" section
				    and attach the pre-created interfaces port2, port3 and port4 respectively. <span class="note">(Be aware that this must be done fast enough to be finished before the
				    VM finishes booting, otherwise the configuration will fail due to the missing interfaces.) (Make sure you attach the right interfaces in the right order to the right device.)</span></li>
				<li>It is wise to change the interface name for the new port1 interface created by AWS during the deployment to conform with names of other interfaces you created manually.</li>
				<li>Repeat this section to deploy the second FortiGate (with the tables switched to "Second FortiGate"), but do not specify the secondary IP address for second ("slave") FortiGate.
			</ul>


		</div>

		<h2>Finish the VPC configuration</h2>
		<div name="indent1">
			<ul>
			<li>Associate the <b>shared</b> public IP to the <b>Resource type</b> "Network interface" and select secondary IP of port1 interface of the master FortiGate <span class="note">(that should be the first one)</span>.
			    <span class="note">(Because the FortiGate has only the secondary IP from AWS configuration configured as primary.)</li>
			<li>In the similar way associate the other two dedicated <b>mgmt</b> public IPs to port4 of each FortiGate.</li>
			<li>In the route table attached to "internal" subnet, create new default route "0.0.0.0/0" with <b>target</b> set to network interface port2
			    of the current master FortiGate  <span class="note">(that should be the first one)</span>.</li>
			</ul>
		</div>

		<h2>Test</h2>
		<div name="indent1">
			<span class="note">Be aware that FortiGate will reboot during the initial deployment and then again when it validates the license.</span>

			<ul>
			<li>It should be possible to ping &amp; SSH to the master FortiGate using the <b>shared</b> public IP.</li>
			<li>It should be possible to ping &amp; SSH to the both FortiGates using the right <b>mgmt</b> public IP.</li>
			<li>HA status should show both FortiGate and the cluster checksum should match.
			    <span class="note">(Synchronizing the configuration can however take few minutes.)</span></li>
			<li>It should be possible to connect as "client" user to the aggresive mode IPSec responder listening on the
			    <b>shared</b> public IP.</li>
			<li>Any additional device running in the "internal" subnet should access Internet through port2 of the master
			    FortiGate device. Using the IPSec connection it should also be possible to connect to this device from outside.</li>
			<li>After HA failover <span class="note">(that can be triggered either by rebooting the current master or by simply
			    changing its HA priority with "override" enabled)</span> the <b>shared</b> public IP, port1 and port2 secondary IPs in AWS,
			    and "internal" subnet default route should be moved to the new master FortiGate.
				 <span class="note">Debug "diagnose debug application awsd -1" can be really helpful when troubleshooting a problem here.</span>
			</ul>
		</div>

	</div>
	</div>


<!-- Additional divs that have special meaning - like dialogs etc. -->

<div id="dialog-userdata" title="User data field contents" data-type="dialog">
	<textarea name="config"></textarea>
</div>

<div id="dialog-iam-role-unicast-ha" title="IAM role for FortiGate unicast HA" data-type="dialog">
<pre>
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:Describe*",
                "ec2:UnassignPrivateIpAddresses",
                "ec2:AssignPrivateIpAddresses",
                "ec2:AssociateAddress",
                "ec2:ReplaceRoute",
                "eks:ListClusters"
            ],
            "Resource": "*"
        }
    ]
}
</pre>
</div>

<div id="static-buttons">
	<fieldset>
		<legend>Global actions:</legend>
		<input type="button" value="Fill all default values" onclick="generate_default_config()"/>
	</fieldset>
</div>

<div id="overlay">
</div>

</body>
</html>
