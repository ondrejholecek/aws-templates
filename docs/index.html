<html>
<head>
	<title>Test</title>

	<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	<script src="networks.js"></script>

	<script>
		function generate_intrazone_config() {
			let config = "";

			// global settings
			config += 'config system global\n';
			config += '    set hostname '        + $('#config-intrazone-fgt input[type=text][name=hostname]').val()       +'\n';
			config += '    set admintimeout '    + $('#config-intrazone-fgt input[type=text][name=admintimeout]').val()   +'\n';
			config += '    set timezone '        + $('#config-intrazone-fgt input[type=text][name=timezone]').val()       +'\n';
			config += 'end\n';
			config += '\n';
			
			// interfaces
			config += 'config system interfaces\n';
			config += '    edit port1\n';
			config += '        set mode static\n';
			config += '        set ip '    + $('#config-intrazone-fgt input[type=text][name=port1ip]').val()   +'\n';
			config += '        set allowaccess ping\n';
			config += '        set alias external\n';
			config += '    next\n';
			config += '    edit port2\n';
			config += '        set mode static\n';
			config += '        set ip '    + $('#config-intrazone-fgt input[type=text][name=port2ip]').val()   +'\n';
			config += '        set allowaccess ping\n';
			config += '        set alias internal\n';
			config += '    next\n';
			config += '    edit port3\n';
			config += '        set mode static\n';
			config += '        set ip '    + $('#config-intrazone-fgt input[type=text][name=port3ip]').val()   +'\n';
			config += '        set allowaccess ping\n';
			config += '        set alias ha\n';
			config += '    next\n';
			config += '    edit port4\n';
			if ($('#config-intrazone-fgt input[type=text][name=port4ip]').val().length > 0) {
			config += '        set mode static\n';
			config += '        set ip '    + $('#config-intrazone-fgt input[type=text][name=port4ip]').val()   +'\n';
			} else {
			config += '        set mode dhcp\n';
			}
			config += '        set allowaccess ping ssh https\n';
			config += '        set alias management\n';
			config += '    next\n';
			config += 'end\n';
			config += '\n';

			// routing
			if ($('#config-intrazone-fgt input[type=checkbox][name=default-route-port1]').is(':checked')) {
				let ip   = IPv4_string_to_number($('#config-intrazone-fgt input[type=text][name=port1ip]').val());
				let mask = IPv4_cidr_to_number($('#config-intrazone-fgt input[type=text][name=port1mask]').val());
				let dgw  = IPv4_number_to_string((ip&mask)+1);

				config += 'config router static\n';
				config += '    edit 0\n';
				config += '        set device port1\n';
				config += '        set gateway ' + dgw + '\n';
				config += '    next\n';
				config += 'end\n';
				config += '\n';
			}

			// ha
			config += 'config system ha\n';
			config += '    set group-name "fgtha"\n';
			config += '    set mode a-p\n';
			config += '    set password topsecret\n';
			config += '    set hbdev "port3" 50\n';
			config += '    set ha-mgmt-status enable\n';
			config += '    config ha-mgmt-interfaces\n';
			config += '        edit 0\n';
			config += '            set interface "port4"\n';
			config += '        next\n';
			config += '    end\n';
			config += '    set override enable\n';
			config += '    set priority ' + $('#config-intrazone-fgt input[type=text][name=ha-priority]').val() + '\n';
			config += '    set unicast-hb enable\n';
			config += '    set unicast-hb-peerip ' + $('#config-intrazone-fgt input[type=text][name=ha-peer]').val() + '\n';
			config += 'end\n';
			config += '\n';

			// firewall policies
			if ($('#config-intrazone-fgt input[type=checkbox][name=policy-default]').is(':checked')) {
				config += 'config firewall policy\n';
				config += '    edit 1\n';
				config += '        set name "default from internal to external"\n';
				config += '        set srcintf "port2"\n';
				config += '        set dstintf "port1"\n';
				config += '        set srcaddr "all"\n';
				config += '        set dstaddr "all"\n';
				config += '        set action accept\n';
				config += '        set schedule "always"\n';
				config += '        set service "ALL"\n';
				config += '        set nat enable\n';
				config += '    next\n';
				config += 'end\n';
				config += '\n'
			}

			$('#config').text(config);
		}

		function onload() {
			$('#config-intrazone-fgt input[type=button][name=generate]').click(generate_intrazone_config);
		}
	</script>
</head>
<body onload="onload()">
	<h1>AAA</h1>

	<table id="config-intrazone-fgt">
		<tr><td>Hostname:</td><td><input type="text" name="hostname" value="fgt"/></td><tr>
		<tr><td>Admin timeout:</td><td><input type="text" name="admintimeout" value="480"/></td><tr>
		<tr><td>Timezone:</td><td><input type="text" name="timezone" value="27"/></td><tr>
		<tr><td>Create default firewall policy from port2 to port1:</td><td><input type="checkbox" name="policy-default" checked/></td><tr>

		<tr><td>Port1 ("external") virtual IP/mask (secondary IP in AWS console):</td><td><input type="text" name="port1ip" value="10.0.1.100"/> / <input type="text" name="port1mask" value="24" size="2"/></td><tr>
		<tr><td>Port2 ("internal") virtual IP/mask (secondary IP in AWS console):</td><td><input type="text" name="port2ip" value="10.0.2.100"/> / <input type="text" name="port2mask" value="24" size=2"/></td><tr>
		<tr><td>Port3 ("ha") IP/mask:</td><td><input type="text" name="port3ip" value="10.0.3.101"/> / <input type="text" name="port3mask" value="24" size="2"/></td><tr>
		<tr><td>Port4 ("management") IP/mask (keep empty for DHCP assigned):</td><td><input type="text" name="port4ip" value=""/> / <input type="text" name="port4mask" value="" size="2"/></td><tr>
		<tr><td>Create default route through port1:</td><td><input type="checkbox" name="default-route-port1" checked/></td><tr>

		<tr><td>HA priority:</td><td><input type="text" name="ha-priority" value="200"/></td><tr>
		<tr><td>HA peer IP:</td><td><input type="text" name="ha-peer" value="10.0.3.102"/></td><tr>

		<tr><td colspan="2"><input type="button" name="generate" value="Generate config script"/></td></tr>
	</table>

	<textarea id="config"></textarea>
</body>
</html>
